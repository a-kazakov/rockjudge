import base64
import json
from typing import Any

import rsa


KEYS = {
    "public": rsa.PublicKey(668904738885797698053050481371213436194973248169499576599609326754253600204828490198314048654603097127290014654797724656282322803747483367395032406243742377357168975587669118600476139560236349894037739300304401317881152798094690402895859164037449886419452225540862955358079278699487250531113997975749640894769112954658329984027975778247525629580812123892149152075621851259227852679693782447515506903742651921600080509047738482493314063457189104758673568007314291932644012837747670139584788986997608678817324269620260850545873422205499821145460209015372538211909915311783027037847811593175715234186374694861317197807599952885355123080237103406204788950299006191123717955087747294807388066698637735039211725171655716844938519859056059612907361432992191962934513986324167609560875291905376466714774477393749356054370499606339618214749171377146267022430158242334467933805206704704903292397655961781892648942546958396611814887014238522707389494493711326309565048910933900679684434404644234236989352944864293257669902596864273070135277101851372151277885651568427319959648902863440878201996028263517845795131200780990321999842831970213346143900564098276874577270951686197459640387028248476955707579065770859617569997014724158073150069799701, 65537)
}


def verify(struct):
    try:
        sig = struct.pop("signature")
        serialized = json.dumps(struct, sort_keys=True)
        return rsa.verify(serialized.encode(), base64.b64decode(sig), KEYS["public"])
    except:
        return False


def decode(encoded: str) -> Any:
    try:
        tmp = encoded.replace("\n", "").replace("\r", "")
        tmp = tmp.encode("utf-8")
        tmp = base64.b64decode(tmp)
        tmp = bytes(x ^ (idx ** 97 % 255) for idx, x in enumerate(tmp, start=1))
        struct = json.loads(tmp.decode("utf-8"))
        if not verify(struct):
            return None
        return struct
    except Exception:
        return None
