import json
import rsa
import base64
import textwrap


try:
    from .keys import KEYS
except ImportError:
    KEYS = {
        "private": rsa.PrivateKey(641142115493706131834127449919397401375980381605954908775318370125615542305155077354948732198618185209552856502721755868074651900708186610994618855067750785887712762965997044264934027192682448807083804155588766295914122152805370578005200524979501946932828846224565525430574504577647404217174356918719121535821410371883583397139521784989280125382583468764402543364687560288352303874816858644451256306208390866758601724955948992658446105118256829549111877765146625841483710267109847778558567132917457590349697015854509883070432804187902485621767709830388117389765599969911069050850498660881175876251002423076542582442250099439421998629065510658437836264484034507756373626417507199828343442312138553045257748875247414453129181869972417290616635385544756997266190572419481081482151720202565510610955034780506052622103840725284644825832811744760037598223905187891354373628409224896520212754111597602060828148405815399935005299269033922453370746866700715071768538726230280238587720504910676563213196327456133332852553733124882522877219429944212411300618565356384676854971590337290388834856906539618556831846623428170621820510201509229952182954258169347149026354139744519008274041343659626372656304595440027440037305711579228959416779136241, 65537, 133429014346379265637512615613327756189129749984338907804546550042621273196820270992632341401909660620307481420275905645431896139184872014089073448041092100168187655432705703445831136562262476452688038892199447388650269497262804969916427818792368082979337666259622033375766447471421226881273800357270093208829641516427669773617741697445241491525291910378529476310343372976682440034615974717360737976416012985515366417850591090694852471545964949543316552494603580112791191606773444220085757619754660788177358096941264633645080382323249492674295280442752392283427880708448923063069819324585774602516749176265666618981797846171241904364251718901729539698777658495515354637365607215947992666313685794213663827250290579853268443805685589054946013400132284578696484855475172565314561615927639837632435310345219151130379503623554837394837867855568888103211400858295623760784268779820368507735753611109604630281262393125027512659878284667890647771559687805782220297892152943714662016533344706891842222695343612207192676676693756315423838431368519177281973454824543765623623720825204551084106420508726194576332447731528461032791431992491919510815600813706298770067274178446537764531669050938337234516464628932057988427724960603946205543376957, 10499461865272208449829993651878515559774445467380009750118014385789633079588350243781604532197864777371002110485821733184297502725388221565220180580184364154568785624443343545457151779651273471895061244908352108217600407857978554579140256029117061436299681061274839947934736412877715790516923169278175399867700072507356147545825801247437992051920013932041012722457116624056742924297049694008260913226969286193630681533496621519032844356468754548185102687028565386187603668498777046651607303539193059151265428161383704685709934961396859173584703968376177629189943075496455790648169683071889057294945694883726597900608984653802881173365443066956309896189807, 61064283457644037825565533549604265643317743437975711975643372280729298203886416053944034547448026628928229436850148408087276888924742013787728022708779102302133785036754271160130782435397839440457135588439198221199156059176919970649049012135675928990054607447662327894284138843373274449377350964481464347940944597670118551069034949781668046783449549519800925854844328975268053378390531123082034563002104308839190257190322982287681847668929868176454799996084612901589740286069518180912313011210686112968534000037651080880361447257295407759284296557869704616042819322377159631263),
        "public": rsa.PublicKey(641142115493706131834127449919397401375980381605954908775318370125615542305155077354948732198618185209552856502721755868074651900708186610994618855067750785887712762965997044264934027192682448807083804155588766295914122152805370578005200524979501946932828846224565525430574504577647404217174356918719121535821410371883583397139521784989280125382583468764402543364687560288352303874816858644451256306208390866758601724955948992658446105118256829549111877765146625841483710267109847778558567132917457590349697015854509883070432804187902485621767709830388117389765599969911069050850498660881175876251002423076542582442250099439421998629065510658437836264484034507756373626417507199828343442312138553045257748875247414453129181869972417290616635385544756997266190572419481081482151720202565510610955034780506052622103840725284644825832811744760037598223905187891354373628409224896520212754111597602060828148405815399935005299269033922453370746866700715071768538726230280238587720504910676563213196327456133332852553733124882522877219429944212411300618565356384676854971590337290388834856906539618556831846623428170621820510201509229952182954258169347149026354139744519008274041343659626372656304595440027440037305711579228959416779136241, 65537),
    }


def sign(struct):
    if "private" not in KEYS:
        raise RuntimeError("Unable to sign: no private key found")
    serialized = json.dumps(struct, sort_keys=True)
    sig = base64.b64encode(rsa.sign(serialized.encode(), KEYS["private"], "SHA-512")).decode()
    struct["signature"] = sig
    return struct


def verify(struct):
    try:
        sig = struct.pop("signature")
        serialized = json.dumps(struct, sort_keys=True)
        return rsa.verify(serialized.encode(), base64.b64decode(sig), KEYS["public"])
    except:
        return False


def encode(struct):
    struct = sign(struct)
    tmp = json.dumps(struct, ensure_ascii=False).encode("utf-8")
    tmp = bytes(x ^ (idx ** 97 % 255) for idx, x in enumerate(tmp, start=1))
    tmp = base64.b64encode(tmp)
    result = "\n".join(textwrap.wrap(tmp.decode(), 80))
    return result


def decode(encoded):
    try:
        tmp = encoded.replace("\n", "").replace("\r", "")
        tmp = tmp.encode()
        tmp = base64.b64decode(tmp)
        tmp = bytes(x ^ (idx ** 97 % 255) for idx, x in enumerate(tmp, start=1))
        struct = json.loads(tmp.decode("utf-8"))
        if not verify(struct):
            return None
        return struct
    except:
        return None
