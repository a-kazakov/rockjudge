import base64
import json
from typing import Any

import rsa


KEYS = {
    "public": rsa.PublicKey(
        668_904_738_885_797_698_053_050_481_371_213_436_194_973_248_169_499_576_599_609_326_754_253_600_204_828_490_198_314_048_654_603_097_127_290_014_654_797_724_656_282_322_803_747_483_367_395_032_406_243_742_377_357_168_975_587_669_118_600_476_139_560_236_349_894_037_739_300_304_401_317_881_152_798_094_690_402_895_859_164_037_449_886_419_452_225_540_862_955_358_079_278_699_487_250_531_113_997_975_749_640_894_769_112_954_658_329_984_027_975_778_247_525_629_580_812_123_892_149_152_075_621_851_259_227_852_679_693_782_447_515_506_903_742_651_921_600_080_509_047_738_482_493_314_063_457_189_104_758_673_568_007_314_291_932_644_012_837_747_670_139_584_788_986_997_608_678_817_324_269_620_260_850_545_873_422_205_499_821_145_460_209_015_372_538_211_909_915_311_783_027_037_847_811_593_175_715_234_186_374_694_861_317_197_807_599_952_885_355_123_080_237_103_406_204_788_950_299_006_191_123_717_955_087_747_294_807_388_066_698_637_735_039_211_725_171_655_716_844_938_519_859_056_059_612_907_361_432_992_191_962_934_513_986_324_167_609_560_875_291_905_376_466_714_774_477_393_749_356_054_370_499_606_339_618_214_749_171_377_146_267_022_430_158_242_334_467_933_805_206_704_704_903_292_397_655_961_781_892_648_942_546_958_396_611_814_887_014_238_522_707_389_494_493_711_326_309_565_048_910_933_900_679_684_434_404_644_234_236_989_352_944_864_293_257_669_902_596_864_273_070_135_277_101_851_372_151_277_885_651_568_427_319_959_648_902_863_440_878_201_996_028_263_517_845_795_131_200_780_990_321_999_842_831_970_213_346_143_900_564_098_276_874_577_270_951_686_197_459_640_387_028_248_476_955_707_579_065_770_859_617_569_997_014_724_158_073_150_069_799_701,
        65537,
    )
}


def verify(struct):
    try:
        sig = struct.pop("signature")
        serialized = json.dumps(struct, sort_keys=True)
        return rsa.verify(serialized.encode(), base64.b64decode(sig), KEYS["public"])
    except:
        return False


def decode(encoded: str) -> Any:
    try:
        tmp = encoded.replace("\n", "").replace("\r", "")
        tmp = tmp.encode("utf-8")
        tmp = base64.b64decode(tmp)
        tmp = bytes(x ^ (idx ** 97 % 255) for idx, x in enumerate(tmp, start=1))
        struct = json.loads(tmp.decode("utf-8"))
        if not verify(struct):
            return None
        return struct
    except Exception:
        return None
